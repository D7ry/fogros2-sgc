# FogROS2 SGC 

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
**Table of Contents**

- [Installation](#installation)
- [Install dependencies](#install-dependencies)
  - [Install Rust](#install-rust)
  - [(Optional) ROS](#optional-ros)
- [Build the repo](#build-the-repo)
  - [Certificate Generation](#certificate-generation)
- [Known issues](#known-issues)
- [Run Demo Image Transport](#run-demo-image-transport)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->


### Local Demo 
If you want to get a taste of FogROS2 SGC without setting up the environment, just run 
```
docker compose build && docker compose up 
```
with docker([Install](https://docs.docker.com/get-docker/)) and docker compose([Install](https://docs.docker.com/compose/install/linux/)). 
It takes some time to build. You will see two docker containers running `talker` and `listener` are connected by FogROS2-SGC.

### Installation 

### Install dependencies 
sudo apt update
sudo apt install build-essential curl pkg-config libssl-dev protobuf-compiler clang

#### Install Rust 
```
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -y
```
and run 
```
source "$HOME/.cargo/env"
```
to configure the environment variables. 

#### Install ROS 
If you only use the machine as a router or proxy, you need 
to change the `default = ["ros"]` to `default = []` in `./core/Cargo.toml`. 

Currently we use ROS2 rolling for development. 
```
sudo apt update && sudo apt install curl
sudo curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(. /etc/os-release && echo $UBUNTU_CODENAME) main" | sudo tee /etc/apt/sources.list.d/ros2.list > /dev/null
sudo apt update
sudo apt install ros-rolling-desktop
```
Then use 
```
source /opt/ros/rolling/setup.bash
```
whenever you launch a new terminal. 


### Build the repo 

The repo is built with 
```
cargo build
```

## Run with Different Machines
In the example, we use two machines to show talker(machine A) and listener(machine B) example. 

#### Certificate Generation
The certificates can be generated by 
```
cd scripts
./generate_crypto.sh
```
Every directory in `./scripts/crypto` contains the cryptographic secrets needed for communication. Simply distribute the directory by copying it to `./scripts/crypto` from machine A and machine B.

#### Run with Environment Variables 
On the machine A
```
export SGC_CONFIG=talker.toml
cargo run 
```
On the machine B
```
export SGC_CONFIG=listener.toml
export GATEWAY_IP=MACHINE_A_IP
cargo run 
```
Replace `MACHINE_A_IP` with the IP address of Machine A. Note that A and B can configure with some intermediate machine C if they are not able to directly connect. Then configure `GATEWAY_IP` on both machines with machine C's ip address. 


To disable the logs and run the benchmark, run with `release` option by 
```
cargo run --release
```

#### Run ROS2 talker and listener
Now run talker and listener on ROS2. 
```
# Machine A: 
ros2 run demo_nodes_cpp talker
```
and 
```
# Machine B
ros2 run demo_nodes_cpp listener
```

### Known issues 
1. segmentation fault / node creation failure: not caused by our project but our underlying framework or ROS rcl itself. Restart the program and the problem should be fixed. The hypothesis is asynchronous error when the nodes are created too fast in parallel. 
